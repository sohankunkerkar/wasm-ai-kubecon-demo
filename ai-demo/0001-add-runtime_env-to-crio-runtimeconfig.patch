From 1f1875ecb42c28ba7ebd6acf3b8e3f0d3c9b4734 Mon Sep 17 00:00:00 2001
From: Sohan Kunkerkar <sohank2602@gmail.com>
Date: Thu, 7 Mar 2024 17:55:31 -0500
Subject: [PATCH] *: add runtime_env to crio runtimeconfig

---
 docs/crio.conf.5.md         |  3 +++
 internal/oci/runtime_oci.go |  5 ++---
 pkg/config/config.go        | 10 ++++++----
 pkg/config/template.go      |  2 ++
 4 files changed, 13 insertions(+), 7 deletions(-)

diff --git a/docs/crio.conf.5.md b/docs/crio.conf.5.md
index f2ae6dcce..aa2503a6f 100644
--- a/docs/crio.conf.5.md
+++ b/docs/crio.conf.5.md
@@ -336,6 +336,9 @@ The "crio.runtime.runtimes" table defines a list of OCI compatible runtimes.  Th
 **runtime_type**="oci"
   Type of the runtime used for this runtime handler. "oci", "vm"
 
+**runtime_env**=[]
+  List of runtime environment variables to use for the runtime handler
+
 **runtime_config_path**=""
   Path to the runtime configuration file, should only be used with VM runtime types
 
diff --git a/internal/oci/runtime_oci.go b/internal/oci/runtime_oci.go
index 5143e8cf2..f99e76b9f 100644
--- a/internal/oci/runtime_oci.go
+++ b/internal/oci/runtime_oci.go
@@ -178,7 +178,7 @@ func (r *runtimeOCI) CreateContainer(ctx context.Context, c *Container, cgroupPa
 	}
 	cmd.ExtraFiles = append(cmd.ExtraFiles, childPipe, childStartPipe)
 	// 0, 1 and 2 are stdin, stdout and stderr
-	cmd.Env = r.handler.MonitorEnv
+	cmd.Env = append(r.handler.RuntimeEnv, r.handler.MonitorEnv...)
 	cmd.Env = append(cmd.Env,
 		fmt.Sprintf("_OCI_SYNCPIPE=%d", 3),
 		fmt.Sprintf("_OCI_STARTPIPE=%d", 4))
@@ -579,10 +579,9 @@ func (r *runtimeOCI) ExecSyncContainer(ctx context.Context, c *Container, comman
 	var stdoutBuf, stderrBuf bytes.Buffer
 	cmd.Stdout = &stdoutBuf
 	cmd.Stderr = &stderrBuf
-
 	cmd.ExtraFiles = append(cmd.ExtraFiles, childPipe, childStartPipe)
 	// 0, 1 and 2 are stdin, stdout and stderr
-	cmd.Env = r.handler.MonitorEnv
+	cmd.Env = append(r.handler.RuntimeEnv, r.handler.MonitorEnv...)
 	cmd.Env = append(cmd.Env,
 		fmt.Sprintf("_OCI_SYNCPIPE=%d", 3),
 		fmt.Sprintf("_OCI_STARTPIPE=%d", 4))
diff --git a/pkg/config/config.go b/pkg/config/config.go
index 8422cd1ff..fb8e6495b 100644
--- a/pkg/config/config.go
+++ b/pkg/config/config.go
@@ -191,10 +191,11 @@ func (c *RootConfig) GetStore() (storage.Store, error) {
 // RuntimeHandler represents each item of the "crio.runtime.runtimes" TOML
 // config table.
 type RuntimeHandler struct {
-	RuntimeConfigPath string `toml:"runtime_config_path"`
-	RuntimePath       string `toml:"runtime_path"`
-	RuntimeType       string `toml:"runtime_type"`
-	RuntimeRoot       string `toml:"runtime_root"`
+	RuntimeConfigPath string   `toml:"runtime_config_path"`
+	RuntimePath       string   `toml:"runtime_path"`
+	RuntimeEnv        []string `toml:"runtime_env"`
+	RuntimeType       string   `toml:"runtime_type"`
+	RuntimeRoot       string   `toml:"runtime_root"`
 
 	// PrivilegedWithoutHostDevices can be used to restrict passing host devices
 	// to a container running as privileged.
@@ -1228,6 +1229,7 @@ func defaultRuntimeHandler() *RuntimeHandler {
 	return &RuntimeHandler{
 		RuntimeType: DefaultRuntimeType,
 		RuntimeRoot: DefaultRuntimeRoot,
+		RuntimeEnv:  []string{},
 		AllowedAnnotations: []string{
 			annotations.OCISeccompBPFHookAnnotation,
 			annotations.DevicesAnnotation,
diff --git a/pkg/config/template.go b/pkg/config/template.go
index 63a54a8bf..c3776d00c 100644
--- a/pkg/config/template.go
+++ b/pkg/config/template.go
@@ -1298,6 +1298,8 @@ const templateStringCrioRuntimeRuntimesRuntimeHandler = `# The "crio.runtime.run
 {{ $.Comment }}[crio.runtime.runtimes.{{ $runtime_name }}]
 {{ $.Comment }}runtime_path = "{{ $runtime_handler.RuntimePath }}"
 {{ $.Comment }}runtime_type = "{{ $runtime_handler.RuntimeType }}"
+{{ $.Comment }}{{ if $runtime_handler.RuntimeEnv }}runtime_env = [
+{{ range $opt := $runtime_handler.RuntimeEnv }}{{ $.Comment }}{{ printf "\t%q,\n" $opt }}{{ end }}{{ $.Comment }}]{{ end }}
 {{ $.Comment }}runtime_root = "{{ $runtime_handler.RuntimeRoot }}"
 {{ $.Comment }}runtime_config_path = "{{ $runtime_handler.RuntimeConfigPath }}"
 {{ $.Comment }}monitor_path = "{{ $runtime_handler.MonitorPath }}"
-- 
2.44.0

